<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.assistant.acc.mapper.poster.PosterMapper">
    <resultMap id="GeneratedAssetFileMap" type="com.assistant.acc.domain.create.poster.PosterElement">

        <!-- PK / 고유키 -->
        <id     property="filePathNo"        column="file_path_no"/>
        <result property="generatedAssetNo"  column="generated_asset_no"/>
        <result property="promotionNo"       column="promotion_no"/>

        <!-- 프롬프트 -->
        <result property="promptNo"          column="prompt_no"/>
        <result property="visualPrompt"      column="visual_prompt"/>
        <result property="styleName"         column="style_name"/>

        <!-- 파일 데이터 -->
        <result property="fileUrl"           column="file_url"/>
        <result property="fileName"          column="file_name"/>
        <result property="extension"         column="extension"/>

        <!-- 타입/식별자 -->
        <result property="generateAssetType" column="generate_asset_type"/>
        <result property="projectNo"               column="p_no"/>
        <result property="memberNo"               column="m_no"/>

    </resultMap>

    <!-- =========================================================
         특정 회원 + 특정 프로젝트 + 특정 타입 자산(포스터/파생물/마스코트) 조회
    ========================================================== -->
    <select id="selectPosterElements"
            parameterType="com.assistant.acc.dto.file.AssetQueryRequest"
            resultMap="GeneratedAssetFileMap">

        SELECT
        gfp.generate_file_path_no    AS file_path_no,
        ga.generated_asset_no        AS generated_asset_no,
        pm.promotion_no              AS promotion_no,
        p.prompt_no                  AS prompt_no,
        p.visual_prompt
        AS visual_prompt,
        p.style_name                 AS style_name,
        gfp.file_path                AS file_url,
        gfp.file_name                AS file_name,
        gfp.extension                AS extension,
        ga.generate_asset_type       AS generate_asset_type,
        pr.p_no                      AS project_no,
        pr.m_no                      AS member_no

        FROM project pr
        JOIN user_input ui          ON pr.p_no = ui.p_no
        JOIN prompt p               ON ui.user_input_no = p.user_input_no
        JOIN promotion pm           ON pm.prompt_no = p.prompt_no
        JOIN generated_asset ga     ON ga.promotion_no = pm.promotion_no
        JOIN generate_file_path gfp ON gfp.generated_asset_no = ga.generated_asset_no

        WHERE pr.p_no = #{projectNo}
        AND ga.generate_asset_type = #{type}

        ORDER BY ga.generated_asset_no ASC, gfp.generate_file_path_no ASC;

    </select>

</mapper>
