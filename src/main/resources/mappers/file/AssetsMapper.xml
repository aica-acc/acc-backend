<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.assistant.acc.mapper.file.AssetsMapper">

    <!-- F/E session에 저장할 List 데이터 -->
    <resultMap id="AssetElementsListMap" type="com.assistant.acc.domain.file.AssetElement">
        <id     property="generatedAssetNo" column="generated_asset_no"/>
        <result property="filePathNo"        column="file_path_no"/>
        <result property="promptNo"          column="prompt_no"/>
    </resultMap>

    <!-- F/E session List에서 가져올 데이터 -->
    <resultMap id="AssetDetailMap" type="com.assistant.acc.domain.file.AssetDetail">
        <result property="fileUrl"       column="file_url"/>
        <result property="fileName"      column="file_name"/>
        <result property="extension"     column="extension"/>
        <result property="promptNo"      column="prompt_no"/>
        <result property="visualPrompt"  column="visual_prompt"/>
        <result property="styleName"     column="style_name"/>
    </resultMap>

    <select id="selectAssetElementList"
            parameterType="com.assistant.acc.dto.file.AssetQueryRequest"
            resultMap="AssetElementsListMap">
        SELECT
        gfp.generate_file_path_no AS file_path_no,
        ga.prompt_no              AS prompt_no,
        ga.generated_asset_no     AS generated_asset_no
        FROM generated_asset ga
        JOIN generate_file_path gfp
        ON gfp.generated_asset_no = ga.generated_asset_no
        WHERE ga.promotion_no = (
        SELECT promotion_no
        FROM promotion
        WHERE p_no = #{projectNo}
        AND promotion_type = #{type}
        ORDER BY created_at DESC
        LIMIT 1
        )
        AND ga.generate_asset_type = #{type}
        ORDER BY ga.generated_asset_no ASC
    </select>

    <select id="getAssetDetail"
            parameterType="com.assistant.acc.dto.file.AssetDetailRequestDto"
            resultMap="AssetDetailMap">

        SELECT
        gfp.file_path    AS file_url,
        gfp.file_name    AS file_name,
        gfp.extension    AS extension,
        p.prompt_no      AS prompt_no,
        p.visual_prompt  AS visual_prompt,
        p.style_name     AS style_name

        FROM generate_file_path gfp
        JOIN generated_asset ga ON gfp.generated_asset_no = ga.generated_asset_no
        JOIN prompt p ON ga.prompt_no = p.prompt_no   <!-- 핵심 변경 -->

        WHERE gfp.generate_file_path_no = #{filePathNo}
        AND p.prompt_no = #{promptNo}

        LIMIT 1;
    </select>

</mapper>
